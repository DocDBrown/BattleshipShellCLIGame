name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  lint-and-test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      # 1. Fix Windows Line Endings (CRLF -> LF)
      - name: Configure Git for LF line endings (Windows)
        if: runner.os == 'Windows'
        run: git config --global core.autocrlf input

      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Install Dependencies
      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck bats

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          # Install Bash 5, Shellcheck, BATS, Coreutils (GNU tools), and GNU Sed
          brew install bash shellcheck bats-core coreutils gnu-sed

          # PREPEND GNU tools to PATH so 'sed', 'mktemp', etc. use the GNU versions
          # instead of the BSD versions native to macOS.
          echo "$(brew --prefix)/opt/coreutils/libexec/gnubin" >> $GITHUB_PATH
          echo "$(brew --prefix)/opt/gnu-sed/libexec/gnubin" >> $GITHUB_PATH
          
          # Ensure the new bash is found first
          echo "$(brew --prefix)/bin" >> $GITHUB_PATH

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          # Install OpenSSL (needed for checksum fallbacks in tests)
          choco install shellcheck openssl
          npm install -g bats

      # 3. Run Lint
      - name: Run shell lint
        shell: bash
        run: |
          set -euo pipefail

          ROOT="."

          if ! command -v shellcheck >/dev/null 2>&1; then
            echo "Error: shellcheck is not installed or not in PATH." >&2
            exit 1
          fi

          sh_files=()
          bats_files=()

          while IFS= read -r -d '' file; do
            case "$file" in
              *.sh)   sh_files+=("$file") ;;
              *.bats) bats_files+=("$file") ;;
            esac
          done < <(
            find "$ROOT" \
              \( -name '.uitg-cache' -o -name 'test' \) -prune -o \
              -type f \( -name '*.sh' -o -name '*.bats' \) -print0
          )

          if ((${#sh_files[@]} > 0)); then
            echo "==> shellcheck on ${#sh_files[@]} .sh files"
            shellcheck -x -P SCRIPTDIR "${sh_files[@]}"
          fi

          if ((${#bats_files[@]} > 0)); then
            echo "==> shellcheck on ${#bats_files[@]} .bats files"
            shellcheck --shell=bats -e SC2329 "${bats_files[@]}"
          fi

          if ((${#sh_files[@]} == 0 && ${#bats_files[@]} == 0)); then
            echo "No .sh or .bats files found under: $ROOT (excluding .uitg-cache and test)"
          fi

      # 4. Run Tests
      - name: Run bats tests
        shell: bash
        run: |
          set -euo pipefail

          RC=0

          # Find all .bats files recursively
          while IFS= read -r -d '' f; do
            echo "Running $f"
            # Use 'timeout' (which is now GNU timeout on macOS too)
            if ! timeout 60s bats "$f"; then
              status=$?
              echo "File $f failed (exit $status)"
              RC=1
            fi
          done < <(
            find . \
              -type d \( -name test -o -name '.uitg-cache' \) -prune -o \
              -type f -name '*.bats' -print0
          )

          exit "$RC"