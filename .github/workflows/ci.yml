name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  lint-and-test:
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, macos-latest ]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install shellcheck and bats (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck bats

      - name: Install shellcheck and bats (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install shellcheck bats-core
          # Ensure bats is on PATH as 'bats'
          if ! command -v bats >/dev/null 2>&1; then
            ln -s "$(brew --prefix bats-core)/bin/bats" /usr/local/bin/bats || true
          fi

      # Lint all .sh and .bats files (excluding .uitg-cache and test)
      - name: Run shell lint
        shell: bash
        run: |
          set -euo pipefail

          ROOT="."

          if ! command -v shellcheck >/dev/null 2>&1; then
            echo "Error: shellcheck is not installed or not in PATH." >&2
            exit 1
          fi

          sh_files=()
          bats_files=()

          while IFS= read -r -d '' file; do
            case "$file" in
              *.sh)   sh_files+=("$file") ;;
              *.bats) bats_files+=("$file") ;;
            esac
          done < <(
            find "$ROOT" \
              \( -name '.uitg-cache' -o -name 'test' \) -prune -o \
              -type f \( -name '*.sh' -o -name '*.bats' \) -print0
          )

          if ((${#sh_files[@]} > 0)); then
            echo "==> shellcheck on ${#sh_files[@]} .sh files"
            shellcheck -x -P SCRIPTDIR "${sh_files[@]}"
          fi

          if ((${#bats_files[@]} > 0)); then
            echo "==> shellcheck on ${#bats_files[@]} .bats files"
            shellcheck --shell=bats "${bats_files[@]}"
          fi

          if ((${#sh_files[@]} == 0 && ${#bats_files[@]} == 0)); then
            echo "No .sh or .bats files found under: $ROOT (excluding .uitg-cache and test)"
          fi

      # Run all .bats tests (excluding ./test and ./.uitg-cache)
      - name: Run bats tests
        shell: bash
        run: |
          set -euo pipefail

          RC=0

          # Find all .bats files recursively from the current directory,
          # excluding ./test and ./.uitg-cache
          while IFS= read -r -d '' f; do
            echo "Running $f"
            if ! timeout 60s bats "$f"; then
              status=$?
              echo "File $f failed (exit $status)"
              RC=1
            fi
          done < <(
            find . \
              -type d \( -name test -o -name '.uitg-cache' \) -prune -o \
              -type f -name '*.bats' -print0
          )

          exit "$RC"
